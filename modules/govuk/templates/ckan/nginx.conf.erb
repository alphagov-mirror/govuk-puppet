# Some API paths expose PII, so we block access by default. We allow access to
# specific paths required by other apps which do not expose PII.

<%-
  allowed_paths = [
    # Used by: ckan.publishing.service.gov.uk
    # Used for: internationalisation of form controls
    "/i18n",

    # Used by: datagovuk_publish
    # Used for: ckan_v26_ckan_org_sync
    "/action/organization_list",
    "/action/organization_show",

    # Used by: datagovuk_publish
    # Used for: ckan_v26_package_sync job
    # Used by: pycsw data load in ckanext-spatial
    # Used for: syncing csw with ckan database
    "/search/dataset",

    # Used by: datagovuk_publish
    # Used for: ckan_v26_package_sync job
    "/action/package_show",

    # Used by: datagovuk_publish
    # Used for: determining filetype
    "/2/util/resource/format_autocomplete",

    # Used by: datagovuk_find
    # Used for: addtional metadata links for datasets
    "/2/rest/harvestobject",

    # Additional endpoints requested by users
    "/action/package_search",
    "/action/package_list",
    "/action/harvest_source_list",
  ]
-%>

<% allowed_paths.each do |path| %>
location /api<%= path %> {
  try_files $uri @app;
}

location /api/3<%= path %> {
  try_files $uri @app;
}
<% end %>

location /csw {
  <%- if @protected -%>
  deny all;
  auth_basic            "Enter the GOV.UK username/password (not your personal username/password)";
  auth_basic_user_file  /etc/govuk.htpasswd;
  satisfy any;
  <%- end -%>

  proxy_pass            http://localhost:<%= @pycsw_port %>;
  proxy_set_header      Host             $host;
  proxy_set_header      X-Real-IP        $remote_addr;
  proxy_set_header      X-Forwarded-For  $proxy_add_x_forwarded_for;
  proxy_set_header      X-Client-Verify  SUCCESS;
  proxy_set_header      X-Client-DN      $ssl_client_s_dn;
  proxy_set_header      X-SSL-Subject    $ssl_client_s_dn;
  proxy_set_header      X-SSL-Issuer     $ssl_client_i_dn;
  proxy_read_timeout    1800;
  proxy_connect_timeout 1800;
}
